name: LYFJSHS Health Record Management System
runtime: python312
plan: standard

services:
  - type: web
    name: health-record-system
    runtime: python
    runtimeVersion: 3.12
    buildCommand: |
      pip install -r requirements.txt
      python src/init_db.py
    startCommand: gunicorn -w 4 -b 0.0.0.0:$PORT "src.app:app"
    envVars:
      - key: FLASK_ENV
        value: production
      - key: FLASK_DEBUG
        value: "False"
      - key: FLASK_HOST
        value: 0.0.0.0
      - key: FLASK_PORT
        generateValue: true
      - key: SECRET_KEY
        generateValue: true
      - key: DATABASE_ENCRYPTION_KEY
        generateValue: true
      - key: MAIL_SERVER
        scope: runtime
      - key: MAIL_PORT
        scope: runtime
      - key: MAIL_USE_TLS
        scope: runtime
      - key: MAIL_USERNAME
        scope: runtime
      - key: MAIL_PASSWORD
        scope: runtime
      - key: MAIL_DEFAULT_SENDER
        value: noreply@lyfjshs.edu.ph

  - type: pserv
    name: health-record-db-backup
    runtime: python
    startCommand: python scripts/backup_database.py
    disk:
      name: backup_volume
      mountPath: /backups
      sizeGB: 10
    envVars:
      - key: BACKUP_ENABLED
        value: "true"
      - key: BACKUP_SCHEDULE
        value: "0 2 * * *" # Daily at 2 AM UTC

# Build hooks for database initialization
buildHooks:
  - name: Initialize Database
    command: python src/init_db.py

# Cron job for database maintenance
preDeployCommand: python src/init_db.py && python scripts/maintenance.py
